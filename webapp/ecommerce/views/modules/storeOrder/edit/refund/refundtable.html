
#if(!$order)
	#set($order = $data)
#end
#set( $refunds = $order.getRefunds() )
#set ( $orderNumber = $order.orderNumber )

#set( $moduleid = $context.findValue("module") )
#set( $viewid = $context.findValue("viewid") )
#set( $viewpath = $context.findValue("viewpath") )

#set( $active = $context.findValue("transid"))

<h3>Refund History for $orderNumber</h3>

#if($refunds.size() == 0)
	<p>No refunds have been processed for this order.</p>
	
	<form method="post" action="$home$apphome/views/modules/storeOrder/edit/refund/newrefund.html">
		<input type="hidden" name="ordernumber" value="$orderNumber"/>
		<input type="hidden" name="viewid" value="$viewid"/>
		<input type="hidden" name="viewpath" value="${moduleid}/${viewpath}"/>
		<input class="btn small" style="float: left" type="submit" value="New" />
	</form>
	<br/>	
#else
	<br/>
	<table cellspacing="5" cellpadding="3" border="0">
		<thead>
			<tr class="results-list-head">
				<th align="center" width="20" nowrap class="results-list-head"></th>
				<th align="center" width="200" nowrap class="results-list-head">Date</th>
				<th align="center" width="200" nowrap class="results-list-head">Transaction ID</th>
				<th align="center" width="100" nowrap class="results-list-head">Subtotal</th>
				<th align="center" width="100" nowrap class="results-list-head">Taxes</th>
				<th align="center" width="100" nowrap class="results-list-head">Total</th>
				<th align="center" width="200" nowrap class="results-list-head">Note</th>
			</tr>
		</thead>
		<tfoot>
			<tr height="30"></tr>
			<tr>
				<th>
					<form method="post" action="$home$apphome/views/modules/storeOrder/edit/refund/newrefund.html">
						<input type="hidden" name="ordernumber" value="$orderNumber"/>
						<input type="hidden" name="viewid" value="$viewid"/>
						<input type="hidden" name="viewpath" value="${moduleid}/${viewpath}"/>
						<input class="btn small" style="float: left" type="submit" value="New" />
					</form>
				</th>
				<th colspan="5"></th>
			</tr>
		</tfoot>
	
	#set($itemCounter = 0)
	#foreach ($refund in $refunds)
		#set($itemCounter = $itemCounter + 1)
		#set($bkgrnd = $itemCounter % 2)
		#if ( $bkgrnd == 0 )
			<tr class="results-list-a">
		#else
			<tr class="results-list-b">
		#end
		
		#set($date = $refund.getDate())
		#set($success = $refund.isSuccess())
		#set($trnid = $refund.getTransactionId())
		#set($subtotal = $refund.getSubTotal())
		#set($tax = $refund.getTaxAmount())
		#set($total = $refund.getTotalAmount())
		#set($message = $refund.getMessage())
		
		#if($success == "true")
			#if(!$sumsubtotal)
				#set($sumsubtotal = $subtotal)
			#else
				#set($sumsubtotal = $sumsubtotal.add($subtotal))
			#end
			
			#if(!$sumtax)
				#set($sumtax = $tax)
			#else
				#set($sumtax = $sumtax.add($tax))
			#end
			
			#if(!$sumtotal)
				#set($sumtotal = $total)
			#else
				#set($sumtotal = $sumtotal.add($total))
			#end
			
		#end
		
			<td style="margin: 3px 0 5px; padding: 5px 10px;">
				<input id="${itemCounter}-button" class="items-button" type="button"  value="+"/>
			</td>
			<td style="margin: 3px 0 5px; padding: 5px 10px;">
				<p class="results-list">
					$date
				</p>
			</td>
			<td align="center" style="margin: 3px 0 5px; padding: 5px 10px;">
				<p class="results-list">
					#if($success == "true") 
						$!trnid 
						#if ($active && $trnid == $active)
							#set($activebutton = "${itemCounter}-button")
						#end
					#end
				</p>
			</td>
			<td align="center" style="margin: 3px 0 5px; padding: 5px 10px;">
				<p class="results-list">
					#if($success == "true") $!subtotal #end
				</p>
			</td>
			<td align="center" style="margin: 3px 0 5px; padding: 5px 10px;">
				<p class="results-list">
					#if($success == "true") $!tax #end
				</p>
			</td>
			<td align="center" style="margin: 3px 0 5px; padding: 5px 10px;">
				<p class="results-list">
					#if($success == "true") $!total #end
				</p>
			</td>
			<td style="margin: 3px 0 5px; padding: 5px 10px;">
				<p class="results-list">
					#if($success == "false") $!message #end
				</p>
			</td>
		</tr>
		
		#set($items = $refund.getItems())
		<tr class="${itemCounter}-button-items" style="display:none;">
			<td></td>
			<td style="font-weight:bold;">Product ID</td>
			<td align="center" style="font-weight:bold;">Sku</td>
			<td align="center" style="font-weight:bold;">Unit Price</td>
			<td align="center" style="font-weight:bold;">Quantity</td>
			<td align="center" style="font-weight:bold;">Subtotal</td>
		</tr>
		
		#foreach ($item in $items)
		<tr class="${itemCounter}-button-items" style="display:none;">
			#if($item.isShipping() == false)
				#set( $product = $store.getProductSearcher().searchByField("id",$item.getId()) )
				#if(!$product)
					#set( $product = $store.getProductSearcher().searchByField("rogerssku",$item.getId()) )
				#end
				#if(!$product)
					#set( $cartitem = $order.getCartItemByProductSku($item.getId()))
					#set( $product = $cartitem.getProduct())
				#end
				#set( $displayname = $product )
			#else
				#set( $shippingmethod = $order.getShippingMethod() )
				#set( $displayname = $shippingmethod.getDescription() )
				#if($displayname.isEmpty())
					#set($displayname = "Shipping")
				#end
			#end
			<td></td>
			<td style="font-size:smaller;font-weight:bold;">$displayname</td>
			<td align="center" style="font-size:smaller;font-weight:bold;">$!item.getId()</td>
			<td align="center" style="font-size:smaller;font-weight:bold;">$item.getUnitPrice()</td>
			<td align="center" style="font-size:smaller;font-weight:bold;">$item.getQuantity()</td>
			<td align="center" style="font-size:smaller;font-weight:bold;">$item.getTotalPrice()</td>
			#set($product = false)
		</tr>
		#end
		
	#end
	
		<tr><td colspan="7"><hr></td></tr>
		<tr>
			<td colspan="3"></td>
			<td align="center" style="margin: 3px 0 5px; padding: 5px 10px;">
				<p class="results-list">
					$!sumsubtotal
				</p>
			</td>
			<td align="center" style="margin: 3px 0 5px; padding: 5px 10px;">
				<p class="results-list">
					$!sumtax
				</p>
			</td>
			<td align="center" style="margin: 3px 0 5px; padding: 5px 10px;">
				<p class="results-list">
					$!sumtotal
				</p>
			</td>
		</tr>
	
	</table>

#end


<script type="text/javascript"">
	$(".items-button").click(function(){
		var id = $(this).attr("id");
		var tableclass = "."+id+"-items";
		var state = $(this).val();
		if (state == "+"){
			state = "-";
		} else {
			state = "+";
		}
		$(this).val(state);
		$(tableclass).toggle();
		
		/*var checked = $(this).attr('checked');
		var source = $(this).attr('name');
		var available = $("#"+source+"-available").val();
		if (checked == undefined)
		{
			$("#"+source+"-quantity").attr('disabled', 'disabled');
			$("#"+source+"-quantity").val(available);
		}
		else
		{
			$("#"+source+"-quantity").removeAttr('disabled');
			$("#"+source+"-quantity").val(available);
		}*/
	});
	
#if($activebutton)
	$(document).ready(function(){
		$("#${activebutton}").click();
	});	
#end

</script>