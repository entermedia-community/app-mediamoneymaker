<div class="ui-widget-content no-padding-for-real_">
#set ( $orderNumber = $order.orderNumber )
#set ( $shippingAddress = $order.getShippingAddress() )
#set ( $billingAddress = $order.getBillingAddress() )
#set ( $customer = $order.customer )
#set ( $searcherManager = $store.getSearcherManager())
#set ( $orderitems = $order.getItems() )
<h2>Order #$orderNumber</h2>
(<a class="btn" href="$apphome/views/modules/storeOrder/actions/recreatecart.html?orderid=${order.orderNumber}">Re-order this</a>)

<h3>Date: $order.dateOrdered</h3>
<p><strong>Status:</strong>&nbsp;$order.getOrderStatus()</p>

#if( $canmanageorders)
	<p><a href="#" onclick="new Ajax.Updater('messagearea', '$home$apphome/orders/sendreceipt.html', { parameters: { orderid: '$order.id', customerid: '$customer.getUserName()' } } ); return false;">Send email</a> receipt</p>
	<span id="messagearea"> </span>
#end

#if ( $shippingAddress.address1 == $billingAddress.address1 )
	#set ( $customerAddress = $order.getBillingAddress() )
#else
	#set ( $customerAddress = $order.getShippingAddress() )
#end

<p style="margin-top: 10px;">
	<b>Customer:</b><br>
	$!customer.getFirstName() $!customer.getLastName()
	#if( $user.hasPermission("oe.cart.admin" ) )
	( <a href="$apphome/views/settings/users/usermanager/user/index.html?username=$customer.userName">$!customer.userName</a> )
	#end<br/>
	$!customerAddress.address1<br>
	#if ( $customerAddress.address2 && $customerAddress.address2 != "" )
		$customerAddress.address2<br>
	#end
	$!customerAddress.city #if ($customerAddress.state || $customerAddress.zipCode || $customerAddress.country),#end $!customerAddress.state $!customerAddress.zipCode $!customerAddress.country<br>
	#if ($customer.phone1)Phone: $customer.phone1<br> #end
	#if ($customer.email)Email: <a href="mailto:$customer.email">$customer.email</a><br> #end
	#if( $customer.fax )
		Fax: $!customer.fax<br>
	#end
	#if( $customer.userfield2 )
	UserField 2: $!customer.userfield2
	#end
</p>

#if ( $order.shippingAddress && $order.shippingAddress.address1 && $order.billingAddress && $order.billingAddress.address1 )
	<p style="margin-top: 10px;">
		<b>Ship to:</b><br>
		$order.shippingAddress.name<br>
		$order.shippingAddress.address1<br>
		#if ( $order.shippingAddress.address2 && $order.shippingAddress.address2 != "" )
			$order.shippingAddress.address2<br>
		#end
		$order.shippingAddress.city, $order.shippingAddress.state $order.shippingAddress.zipCode $!order.shippingAddress.country<br>
	</p>
#end

<hr>
<h3>Order Details</h3>

<table cellspacing="5" class="standard-table" cellpadding="3" border="0">
	<tr class="results-list-head">
		<th align="left" class="results-list-head">Acc.<br>ID</th>
		<th align="left" class="results-list-head" style="padding-left: 10px;">Product</th>
		<th align="center" class="results-list-head">SKU</th>
		<th align="center" width="100"  class="results-list-head">Quantity</th>
		<th align="right" class="results-list-head">Unit Price</th>
		<th align="right" class="results-list-head">Subtotal</th>
		<th align="center" width="100" nowrap class="results-list-head">Shipment Status</th>
		<th align="center" width="100" nowrap class="results-list-head">Refunds</th>
		<th align="center" width="100" nowrap class="results-list-head">Distributor</th>
	</tr>
	#set( $types = $searcherManager.getList($catalogid ,"itemstatus") )
	
#set($itemCounter = 0)
#foreach ( $item in $orderitems )
	#set( $productid = $item.getProduct().getId() )
	#set( $product = $store.getProductSearcher().searchById($productid) )
	#set( $path ="$apphome/products/${product.getSourcePath()}.html")
	#set( $itemCounter = $itemCounter + 1)
	#set( $bkgrnd = $itemCounter % 2)
	#if ( $bkgrnd == 0 )
	<tr class="results-list-a">
	#else
	<tr class="results-list-b">
	#end
		<td><p class="results-list">${productid}</p></td>
		<td>
			<p class="results-list" style="margin-left: 10px;">
				#if($product.isCoupon())
					$product.getName()
				#else
				<a class="results-list" href="$home$path" target="_blank" 
				style="font-size: 14px; color: blue;">$product.getName()</a>
				#end
			<input type="hidden" name="sku" value="$item.sku"/>
			<input type="hidden" name="ordernumber" value="$orderNumber"/>
			<input type="hidden" name="origURL" value="$content.path"/></p></td>
		<td align="center">
			<p class="results-list">
				#if($product.isCoupon()) $item.sku  #else $product.manufacturersku #end
			</p>
		</td>
		<td align="center">
			<p class="results-list">$item.quantity</p>
		</td>
		<td align="right">
			<p class="results-list">
				#if($product.isCoupon())
					$order.getCouponPrice($item)
				#else
					#set($adjustment = $order.getPriceAdjustment($item))
					#if($adjustment.isZero())
						$item.getYourPrice()
					#else
						$adjustment ($item.getYourPrice())
					#end
				#end
			</p>
		</td>
		<td align="right">
			<p class="results-list">
				$order.getTotalPrice($item)
			</p>
		</td>
		<td align="center" nowrap>
			<p class="results-list">
				#if($product.isCoupon())
					N/A
				#else
					#set($quantityrefunded = $order.getQuantityRefunded($item))
					#set($delta = $item.quantity - $quantityrefunded)
					#if ( $order.getQuantityShipped($item) == $delta )
						Shipped
					#else
						#if ( $order.getQuantityShipped($item) > 0 )
							Partially Shipped
						#else
							Waiting<br/>for Shipment
						#end
					#end
				#end
			</p>
		</td>
		<td align="center" nowrap>
			<p class="results-list">
				#set($quantityrefunded = $order.getQuantityRefunded($item))
				#if($quantityrefunded > 0)
					<a href="/ecommerce/views/modules/storeOrder/edit/refund/index.html?id=${order.id}&viewid=orderrefunds&viewpath=storeOrder/orderrefunds" style="color:blue;text-decoration:underline;font-weight:normal;">
						$quantityrefunded
					</a>
				#else
					0
				#end
			</p>
		</td>
		<td align="center" nowrap>
			<p class="results-list">
			#set($distributorsearcher = $searcherManager.getSearcher($catalogid, "distributor"))
			#set($d = $distributorsearcher.searchById($product.get("distributor")))
			#set($invoicesearcher = $searcherManager.getSearcher($catalogid, "invoice"))
			#set($invoices = $invoicesearcher.fieldSearch("ponumber", $orderNumber))
			#if ($invoices.size() > 1)
				#set($breakflag = "false")
				#foreach( $inv in $invoices)
					#set($invoiceID = $inv.getId())
					#set($dID = $d.getId())
					#set($idist = $inv.get("distributor"))
					#set($dname = $d.getName())
					#if ($invoiceID != "" && $dID == $idist)
						#set($url = "/ecommerce/views/modules/invoice/edit/export/index.html?id=$invoiceID&hitssessionid=hitsinvoicemedia/catalogs/store&searchtype=invoice")
						<a href="$url" style="font-size: 14px; color: blue;">$dname</a>
						#set($breakflag = "true")
						#break
					#end
				#end
				#if($breakflag == "false")
					$d.get("name")
				#end
			#else
				#set($breakflag = "false")
				#if ($invoices.size() == 1)
					#set($inv = $invoices.get(0))
					#set($invoiceID = $inv.getId())
					#set($dID = $d.getId())
					#set($idist = $inv.get("distributor"))
					#if ($invoiceID != "" && $dID == $idist)
						#set($url = "/ecommerce/views/modules/invoice/edit/export/index.html?id=$invoiceID&hitssessionid=hitsinvoicemedia/catalogs/store&searchtype=invoice")
						<a href="$url" style="font-size: 14px; color: blue;">$d.get("name")</a>
						#set($breakflag = "true")
					#end
					#if($breakflag == "false")
						$d.get("name")
					#end
				#else
					$d.get("name")
				#end
			#end
			</p>
		</td>
	</tr>
#end
#if(!$order.getAdjustments().isEmpty())
	#set( $itemCounter = $itemCounter + 1)
	#set( $bkgrnd = $itemCounter % 2)
	#if ( $bkgrnd == 0 )
	<tr class="results-list-a">
	#else
	<tr class="results-list-b">
	#end
		<td colspan="9">
		$order.getAdjustments()
		</td>
	</tr>
#end
	<tr style="border-top: 1px solid black;">
		<td colspan="5" align="right">Subtotal:&nbsp;&nbsp;</td>
		<td align="right">$order.getSubTotal()</td>
		<td colspan="2">&nbsp;</td>
	</tr>
#if ( $order.getTotalShipping() && $order.getTotalShipping().isZero() == "false" )
	<tr>
		  <td colspan="5" align="right">Shipping:&nbsp;&nbsp;</td>
		  <td align="right">$order.getTotalShipping()</td>
		  <td colspan="2">&nbsp;</td>
	</tr>
#else
	<tr>
		  <td colspan="5" align="right">Shipping:&nbsp;&nbsp;</td>
		  <td align="right">$0.00</td>
		  <td colspan="2">&nbsp;</td>
	</tr>
#end
	<tr>
		<td colspan="5" align="right">Tax:&nbsp;&nbsp;</td>
		<td align="right">$order.tax</td>
		<td colspan="2">&nbsp;</td>
	</tr>
	<tr>
		<td colspan="5" align="right"><b>Grand Total:&nbsp;&nbsp;</b></td>
		<td align="right"><b>$order.totalPrice</b></td>
		<td colspan="2">&nbsp;</td>
	</tr>
</table>

<hr>
<h3>Refund Details</h3>

#set( $refunds = $order.getRefunds() )
#if($refunds.size() == 0)
	<p>No refunds have been processed for this order. <a href="/ecommerce/views/modules/storeOrder/edit/refund/index.html?id=${order.id}&viewid=orderrefunds&viewpath=storeOrder/orderrefunds" style="color:blue;text-decoration:none;font-weight:normal;">Click here to issue one.</a></p>
#else
	#foreach ($refund in $refunds)
		#set($success = $refund.isSuccess())
		#set($subtotal = $refund.getSubTotal())
		#set($tax = $refund.getTaxAmount())
		#set($total = $refund.getTotalAmount())
		#if($success == "true")
			#set($refunditems = $refund.getItems())
			#foreach($refunditem in $refunditems)
				#if($refunditem.isShipping())
					#if(!$shippingrefunds)
						#set($shippingrefunds = $refunditem.getTotalPrice())
					#else
						#set($shippingrefund = $refunditem.getTotalPrice())
						#set($shippingrefunds = $shippingrefunds.add($shippingrefund))
					#end
				#end
			#end
			#if(!$sumsubtotal)
				#set($sumsubtotal = $subtotal)
			#else
				#set($sumsubtotal = $sumsubtotal.add($subtotal))
			#end
			
			#if(!$sumtax)
				#set($sumtax = $tax)
			#else
				#set($sumtax = $sumtax.add($tax))
			#end
			
			#if(!$sumtotal)
				#set($sumtotal = $total)
			#else
				#set($sumtotal = $sumtotal.add($total))
			#end
		#end
	#end
	
	#if($shippingrefunds)
		#set($cartitemrefunds = $sumsubtotal.subtract($shippingrefunds))
	#else
		#set($D = "$")
		#set($shippingrefunds = "${D}0.00")
		#set($cartitemrefunds = $sumsubtotal)
	#end

	<table cellspacing="5" cellpadding="3" border="0">
		<thead>
			<tr class="results-list-head">
				<th align="center" width="100" nowrap class="results-list-head">Shipping</th>
				<th align="center" width="100" nowrap class="results-list-head">Cart Items</th>
				<th align="center" width="100" nowrap class="results-list-head">Subtotal</th>
				<th align="center" width="100" nowrap class="results-list-head">Taxes</th>
				<th align="center" width="100" nowrap class="results-list-head">Total</th>
			</tr>
		</thead>
		<tr>
			<td align="center" style="margin: 3px 0 5px; padding: 5px 10px;">
				<p class="results-list">
					$!shippingrefunds
				</p>
			</td>
			<td align="center" style="margin: 3px 0 5px; padding: 5px 10px;">
				<p class="results-list">
					$!cartitemrefunds
				</p>
			</td>
			<td align="center" style="margin: 3px 0 5px; padding: 5px 10px;">
				<p class="results-list">
					$!sumsubtotal
				</p>
			</td>
			<td align="center" style="margin: 3px 0 5px; padding: 5px 10px;">
				<p class="results-list">
					$!sumtax
				</p>
			</td>
			<td align="center" style="margin: 3px 0 5px; padding: 5px 10px;">
				<p class="results-list">
					$!sumtotal
				</p>
			</td>
		</tr>
	</table>
#end

<hr>
<h3>Payment Details</h3>
<p>
	#if ( $order.paymentMethod.cardNumber && $order.paymentMethod.cardNumber != "" )
		#if( $order.getOrderState().getId() == "authorized" )
			Authorized $order.totalPrice to <b>$order.paymentMethod.creditCardType</b><br>
		#elseif( $order.getOrderState().getId() == "captured" )
			Captured $order.totalPrice to <b>$order.paymentMethod.creditCardType</b><br>
		#else
			Accepted $order.totalPrice on <b>$order.paymentMethod.creditCardType</b><br>
		#end

		#set($cardNumber = $order.getPaymentMethod().getMaskedCardNumber())
		#if($cardNumber)
			Card number: $cardNumber<br>
		#else
			Card number: Not possible to display.<br>
		#end
		Expiration date: $order.paymentMethod.expirationDateString<br>
		#if( $canmanageorders )

		#if( $order.getOrderState().getId() == "authorized" )
		<br>
			<form action="$home$apphome/admin/orders/captureorder.html" name="capture">
				Once the product is shipped then charges can be applied:
				<!-- Note to customer: <br><textarea rows=5 cols=20 name="note"></textarea>
				<br> -->
				<input type="submit" value="Capture Order" />			
				<input type="hidden" name="ordernumber" value="$order.getOrderNumber()" />
			</form>
		#end
	#end
#end

#if ( $order.paymentMethod.poNumber )
	<strong>Purchase Order:</strong> $order.paymentMethod.poNumber<br>
#end
#if ( $order.paymentMethod.billMeLater )
	<strong>Payment Method:</strong> Bill Me Later<br />
#end
#if ( $order.paymentMethod.note )
	<stong>Notes:</stong><br/>$order.paymentMethod.note
#end
</p>
</div>
<!-- 
<a href="$home$apphome/views/modules/storeOrder/shippingdetails/index.html?id=$orderNumber&oemaxlevel=1" class="results-list thickbox uibutton">
<a href="/ecommerce/views/modules/storeOrder/shippingdetails/index.html?id=WEB0000076&oemaxlevel=1" class="thickbox uibutton" target="_parent">
<script language="JavaScript" type="text/javascript">
function openWindow()
{
window.open("/ecommerce/views/modules/storeOrder/shippingdetails/index.html?id=WEB0000076&oemaxlevel=1","viewer","height=570, width=450, left=100, top=50, menubar=no, status=no, location=no, toolbar=no, scrollbars=no, resizable=yes");
}
</script>
 -->